From b23d8f3d561ce225c44d57107e872972388f4d20 Mon Sep 17 00:00:00 2001
From: Andy CrossGate Yan <GeForce8800Ultra@gmail.com>
Date: Wed, 7 Oct 2020 14:00:35 +0000
Subject: [PATCH 14/19] UI: Always render windows into cutouts

Eliminates black/white letterboxing
Quick and dirty way to do the latter - wait for proper fix from Google

Change-Id: I4661c7979bfa7de453329fcddbaeefc2009e2da3
---
 .../com/android/server/wm/DisplayFrames.java  | 19 ++++---------------
 .../com/android/server/wm/DisplayPolicy.java  |  1 +
 2 files changed, 5 insertions(+), 15 deletions(-)

diff --git a/services/core/java/com/android/server/wm/DisplayFrames.java b/services/core/java/com/android/server/wm/DisplayFrames.java
index fd0631320520..97989e086c74 100644
--- a/services/core/java/com/android/server/wm/DisplayFrames.java
+++ b/services/core/java/com/android/server/wm/DisplayFrames.java
@@ -99,21 +99,10 @@ public class DisplayFrames {
         state.setRoundedCorners(roundedCorners);
         state.setPrivacyIndicatorBounds(indicatorBounds);
         state.getDisplayCutoutSafe(safe);
-        if (!cutout.isEmpty()) {
-            state.getSource(ITYPE_LEFT_DISPLAY_CUTOUT).setFrame(
-                    unrestricted.left, unrestricted.top, safe.left, unrestricted.bottom);
-            state.getSource(ITYPE_TOP_DISPLAY_CUTOUT).setFrame(
-                    unrestricted.left, unrestricted.top, unrestricted.right, safe.top);
-            state.getSource(ITYPE_RIGHT_DISPLAY_CUTOUT).setFrame(
-                    safe.right, unrestricted.top, unrestricted.right, unrestricted.bottom);
-            state.getSource(ITYPE_BOTTOM_DISPLAY_CUTOUT).setFrame(
-                    unrestricted.left, safe.bottom, unrestricted.right, unrestricted.bottom);
-        } else {
-            state.removeSource(ITYPE_LEFT_DISPLAY_CUTOUT);
-            state.removeSource(ITYPE_TOP_DISPLAY_CUTOUT);
-            state.removeSource(ITYPE_RIGHT_DISPLAY_CUTOUT);
-            state.removeSource(ITYPE_BOTTOM_DISPLAY_CUTOUT);
-        }
+        state.removeSource(ITYPE_LEFT_DISPLAY_CUTOUT);
+        state.removeSource(ITYPE_TOP_DISPLAY_CUTOUT);
+        state.removeSource(ITYPE_RIGHT_DISPLAY_CUTOUT);
+        state.removeSource(ITYPE_BOTTOM_DISPLAY_CUTOUT);
         return true;
     }
 
diff --git a/services/core/java/com/android/server/wm/DisplayPolicy.java b/services/core/java/com/android/server/wm/DisplayPolicy.java
index 7e91989a9105..a42f8c12c792 100644
--- a/services/core/java/com/android/server/wm/DisplayPolicy.java
+++ b/services/core/java/com/android/server/wm/DisplayPolicy.java
@@ -1558,6 +1558,7 @@ public class DisplayPolicy {
         displayFrames = win.getDisplayFrames(displayFrames);
 
         final WindowManager.LayoutParams attrs = win.getLayoutingAttrs(displayFrames.mRotation);
+        attrs.layoutInDisplayCutoutMode = LAYOUT_IN_DISPLAY_CUTOUT_MODE_ALWAYS;
         final Rect attachedWindowFrame = attached != null ? attached.getFrame() : null;
 
         // If this window has different LayoutParams for rotations, we cannot trust its requested
-- 
2.25.1


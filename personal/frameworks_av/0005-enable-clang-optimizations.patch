From e93498e0db3016899fbc077037f336ae5d57063e Mon Sep 17 00:00:00 2001
From: Victor Bo <bvoid@yandex.ru>
Date: Thu, 25 Mar 2021 06:49:09 -0400
Subject: [PATCH 5/7] enable clang optimizations

---
 camera/Android.bp                                   | 1 +
 camera/cameraserver/Android.bp                      | 1 +
 cmds/screenrecord/Android.bp                        | 1 +
 media/bufferpool/2.0/Android.bp                     | 1 +
 media/codec2/components/amr_nb_wb/Android.bp        | 1 +
 media/codec2/components/avc/Android.bp              | 1 +
 media/codec2/components/base/Android.bp             | 1 +
 media/codec2/components/cmds/Android.bp             | 1 +
 media/codec2/components/g711/Android.bp             | 1 +
 media/codec2/components/gav1/Android.bp             | 1 +
 media/codec2/components/mpeg4_h263/Android.bp       | 4 ++++
 media/codec2/components/vpx/Android.bp              | 3 ++-
 media/codec2/core/Android.bp                        | 1 +
 media/codec2/vndk/Android.bp                        | 1 +
 media/extractors/Android.bp                         | 3 ++-
 media/libaaudio/examples/input_monitor/Android.bp   | 4 ++--
 media/libaaudio/examples/loopback/Android.bp        | 2 +-
 media/libaaudio/examples/write_sine/Android.bp      | 4 ++--
 media/libaaudio/src/Android.bp                      | 2 ++
 media/libaudioclient/Android.bp                     | 2 ++
 media/libaudiofoundation/Android.bp                 | 1 +
 media/libaudiohal/Android.bp                        | 2 ++
 media/libaudiohal/impl/Android.bp                   | 5 +++++
 media/libaudioprocessing/Android.bp                 | 1 +
 media/libaudioprocessing/audio-resampler/Android.bp | 1 +
 media/libcpustats/Android.bp                        | 1 +
 media/libeffects/downmix/Android.bp                 | 1 +
 media/libeffects/dynamicsproc/Android.bp            | 3 +--
 media/libeffects/factory/Android.bp                 | 3 ++-
 media/libeffects/loudness/Android.bp                | 3 +--
 media/libeffects/preprocessing/Android.bp           | 1 +
 media/libeffects/proxy/Android.bp                   | 1 +
 media/libheif/Android.bp                            | 1 +
 media/libmedia/Android.bp                           | 5 +++++
 media/libmedia/xsd/vts/Android.bp                   | 1 +
 media/libmediahelper/Android.bp                     | 1 +
 media/libmediametrics/Android.bp                    | 1 +
 media/libmediaplayerservice/Android.bp              | 1 +
 media/libmediaplayerservice/nuplayer/Android.bp     | 2 ++
 media/libmediatranscoding/Android.bp                | 1 +
 media/libnbaio/Android.bp                           | 1 +
 media/libstagefright/Android.bp                     | 8 +++++++-
 media/libstagefright/codecs/amrnb/common/Android.bp | 2 +-
 media/libstagefright/codecs/amrnb/dec/Android.bp    | 5 +++--
 media/libstagefright/codecs/amrwb/Android.bp        | 4 ++--
 media/libstagefright/codecs/amrwbenc/Android.bp     | 4 +++-
 media/libstagefright/codecs/avcdec/Android.bp       | 1 +
 media/libstagefright/codecs/avcenc/Android.bp       | 1 +
 media/libstagefright/codecs/common/Android.bp       | 2 +-
 media/libstagefright/codecs/hevcdec/Android.bp      | 1 +
 media/libstagefright/codecs/m4v_h263/dec/Android.bp | 2 ++
 media/libstagefright/codecs/mp3dec/Android.bp       | 3 ++-
 media/libstagefright/codecs/mpeg2dec/Android.bp     | 1 +
 media/libstagefright/codecs/on2/enc/Android.bp      | 2 +-
 media/libstagefright/codecs/xaacdec/Android.bp      | 3 ++-
 media/libstagefright/colorconversion/Android.bp     | 2 +-
 media/libstagefright/filters/Android.bp             | 1 +
 media/libstagefright/flac/dec/Android.bp            | 2 +-
 media/libstagefright/foundation/Android.bp          | 3 +++
 media/libstagefright/http/Android.bp                | 1 +
 media/libstagefright/mpeg2ts/Android.bp             | 1 +
 media/libstagefright/omx/Android.bp                 | 6 +++++-
 media/libstagefright/rtsp/Android.bp                | 4 +++-
 media/libstagefright/webm/Android.bp                | 3 ++-
 media/mediaserver/Android.bp                        | 2 ++
 media/mtp/Android.bp                                | 1 +
 media/ndk/Android.bp                                | 3 +++
 media/utils/Android.bp                              | 1 +
 services/audioflinger/Android.bp                    | 1 +
 services/camera/libcameraservice/Android.bp         | 1 +
 services/mediacodec/Android.bp                      | 2 ++
 services/mediaextractor/Android.bp                  | 2 ++
 services/mediametrics/Android.bp                    | 1 +
 services/mediatranscoding/Android.bp                | 2 ++
 services/minijail/Android.bp                        | 1 +
 75 files changed, 124 insertions(+), 28 deletions(-)

diff --git a/camera/Android.bp b/camera/Android.bp
index fa36bb31b1..9a4a45aa7b 100644
--- a/camera/Android.bp
+++ b/camera/Android.bp
@@ -73,6 +73,7 @@ cc_library_shared {
         "-Werror",
         "-Wall",
         "-Wextra",
+        "-O3",
     ],
 
 }
diff --git a/camera/cameraserver/Android.bp b/camera/cameraserver/Android.bp
index dc7f88a49c..aec597981e 100644
--- a/camera/cameraserver/Android.bp
+++ b/camera/cameraserver/Android.bp
@@ -43,6 +43,7 @@ cc_binary {
         "-Wextra",
         "-Werror",
         "-Wno-unused-parameter",
+        "-O3",
     ],
 
     init_rc: ["cameraserver.rc"],
diff --git a/cmds/screenrecord/Android.bp b/cmds/screenrecord/Android.bp
index d7d905fbca..f1487d8d9b 100644
--- a/cmds/screenrecord/Android.bp
+++ b/cmds/screenrecord/Android.bp
@@ -53,6 +53,7 @@ cc_binary {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wall",
         "-Wno-multichar",
diff --git a/media/bufferpool/2.0/Android.bp b/media/bufferpool/2.0/Android.bp
index 536f75e64f..81431daccb 100644
--- a/media/bufferpool/2.0/Android.bp
+++ b/media/bufferpool/2.0/Android.bp
@@ -35,6 +35,7 @@ cc_library {
     double_loadable: true,
     cflags: [
         "-DBUFFERPOOL_CLONE_HANDLES",
+        "-O3",
     ],
 }
 
diff --git a/media/codec2/components/amr_nb_wb/Android.bp b/media/codec2/components/amr_nb_wb/Android.bp
index ce25bc98a2..5aeef697c5 100644
--- a/media/codec2/components/amr_nb_wb/Android.bp
+++ b/media/codec2/components/amr_nb_wb/Android.bp
@@ -9,6 +9,7 @@ cc_library_shared {
 
     cflags: [
         "-DAMRNB",
+        "-O3",
     ],
 
     static_libs: [
diff --git a/media/codec2/components/avc/Android.bp b/media/codec2/components/avc/Android.bp
index 4021444beb..608ee43e26 100644
--- a/media/codec2/components/avc/Android.bp
+++ b/media/codec2/components/avc/Android.bp
@@ -33,5 +33,6 @@ cc_library_shared {
 
     cflags: [
         "-Wno-unused-variable",
+        "-O3",
     ],
 }
diff --git a/media/codec2/components/base/Android.bp b/media/codec2/components/base/Android.bp
index f10835f366..4382a4d145 100644
--- a/media/codec2/components/base/Android.bp
+++ b/media/codec2/components/base/Android.bp
@@ -61,6 +61,7 @@ cc_defaults {
     ],
 
     cflags: [
+        "-O3",
         "-Wall",
         "-Werror",
     ],
diff --git a/media/codec2/components/cmds/Android.bp b/media/codec2/components/cmds/Android.bp
index a081e2871c..23db570bda 100644
--- a/media/codec2/components/cmds/Android.bp
+++ b/media/codec2/components/cmds/Android.bp
@@ -29,6 +29,7 @@ cc_binary {
     cflags: [
         "-Werror",
         "-Wall",
+        "-O3",
     ],
 
     sanitize: {
diff --git a/media/codec2/components/g711/Android.bp b/media/codec2/components/g711/Android.bp
index 3ede68c617..bcd5661904 100644
--- a/media/codec2/components/g711/Android.bp
+++ b/media/codec2/components/g711/Android.bp
@@ -9,6 +9,7 @@ cc_library_shared {
 
     cflags: [
         "-DALAW",
+        "-O3",
     ],
 }
 
diff --git a/media/codec2/components/gav1/Android.bp b/media/codec2/components/gav1/Android.bp
index f37408935a..787bfe022d 100644
--- a/media/codec2/components/gav1/Android.bp
+++ b/media/codec2/components/gav1/Android.bp
@@ -9,6 +9,7 @@ cc_library_shared {
     // so only 1 of them has the official c2.android.av1.decoder name
     cflags: [
         "-DCODECNAME=\"c2.android.av1.decoder\"",
+        "-O3",
     ],
 
     srcs: ["C2SoftGav1Dec.cpp"],
diff --git a/media/codec2/components/mpeg4_h263/Android.bp b/media/codec2/components/mpeg4_h263/Android.bp
index 41e4f44655..21ea649554 100644
--- a/media/codec2/components/mpeg4_h263/Android.bp
+++ b/media/codec2/components/mpeg4_h263/Android.bp
@@ -12,6 +12,7 @@ cc_library_shared {
     cflags: [
         "-DOSCL_IMPORT_REF=",
         "-DMPEG4",
+        "-O3",
     ],
 }
 
@@ -28,6 +29,7 @@ cc_library_shared {
 
     cflags: [
         "-DOSCL_IMPORT_REF=",
+        "-O3",
     ],
 }
 
@@ -46,6 +48,7 @@ cc_library_shared {
     cflags: [
         "-DMPEG4",
         "-DOSCL_IMPORT_REF=",
+        "-O3",
     ],
 }
 
@@ -62,5 +65,6 @@ cc_library_shared {
 
     cflags: [
         "-DOSCL_IMPORT_REF=",
+        "-O3",
     ],
 }
diff --git a/media/codec2/components/vpx/Android.bp b/media/codec2/components/vpx/Android.bp
index 34f5753ac3..bfc6ae7328 100644
--- a/media/codec2/components/vpx/Android.bp
+++ b/media/codec2/components/vpx/Android.bp
@@ -11,6 +11,7 @@ cc_library_shared {
 
     cflags: [
         "-DVP9",
+        "-O3",
     ],
 }
 
@@ -40,7 +41,7 @@ cc_library_shared {
 
     shared_libs: ["libvpx"],
 
-    cflags: ["-DVP9"],
+    cflags: ["-DVP9", "-O3"],
 }
 
 cc_library_shared {
diff --git a/media/codec2/core/Android.bp b/media/codec2/core/Android.bp
index ce1c9acc44..b9b04789a0 100644
--- a/media/codec2/core/Android.bp
+++ b/media/codec2/core/Android.bp
@@ -17,6 +17,7 @@ cc_library_shared {
     srcs: ["C2.cpp"],
 
     cflags: [
+        "-O3",
         "-Wall",
         "-Werror",
     ],
diff --git a/media/codec2/vndk/Android.bp b/media/codec2/vndk/Android.bp
index 6f7acce656..6c35692506 100644
--- a/media/codec2/vndk/Android.bp
+++ b/media/codec2/vndk/Android.bp
@@ -76,6 +76,7 @@ cc_library_shared {
     cflags: [
         "-Werror",
         "-Wall",
+        "-O3",
     ],
 }
 
diff --git a/media/extractors/Android.bp b/media/extractors/Android.bp
index 7c4e62faab..4df471d8ec 100644
--- a/media/extractors/Android.bp
+++ b/media/extractors/Android.bp
@@ -32,6 +32,7 @@ cc_defaults {
     compile_multilib: "first",
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wall",
         "-fvisibility=hidden",
@@ -46,4 +47,4 @@ cc_defaults {
             "signed-integer-overflow",
         ],
     },
-}
\ No newline at end of file
+}
diff --git a/media/libaaudio/examples/input_monitor/Android.bp b/media/libaaudio/examples/input_monitor/Android.bp
index d8c58431fc..20819cf4f4 100644
--- a/media/libaaudio/examples/input_monitor/Android.bp
+++ b/media/libaaudio/examples/input_monitor/Android.bp
@@ -2,7 +2,7 @@ cc_test {
     name: "input_monitor",
     gtest: false,
     srcs: ["src/input_monitor.cpp"],
-    cflags: ["-Wall", "-Werror"],
+    cflags: ["-Wall", "-Werror", "-O3"],
     shared_libs: ["libaaudio"],
     header_libs: ["libaaudio_example_utils"],
 }
@@ -11,7 +11,7 @@ cc_test {
     name: "input_monitor_callback",
     gtest: false,
     srcs: ["src/input_monitor_callback.cpp"],
-    cflags: ["-Wall", "-Werror"],
+    cflags: ["-Wall", "-Werror", "-O3"],
     shared_libs: ["libaaudio"],
     header_libs: ["libaaudio_example_utils"],
 }
diff --git a/media/libaaudio/examples/loopback/Android.bp b/media/libaaudio/examples/loopback/Android.bp
index 5b7d956294..1ae7747b87 100644
--- a/media/libaaudio/examples/loopback/Android.bp
+++ b/media/libaaudio/examples/loopback/Android.bp
@@ -2,7 +2,7 @@ cc_test {
     name: "aaudio_loopback",
     gtest: false,
     srcs: ["src/loopback.cpp"],
-    cflags: ["-Wall", "-Werror"],
+    cflags: ["-Wall", "-Werror", "-O3"],
     static_libs: ["libsndfile"],
     shared_libs: [
         "libaaudio",
diff --git a/media/libaaudio/examples/write_sine/Android.bp b/media/libaaudio/examples/write_sine/Android.bp
index aa25e67b4b..83e271198f 100644
--- a/media/libaaudio/examples/write_sine/Android.bp
+++ b/media/libaaudio/examples/write_sine/Android.bp
@@ -1,7 +1,7 @@
 cc_test {
     name: "write_sine",
     srcs: ["src/write_sine.cpp"],
-    cflags: ["-Wall", "-Werror"],
+    cflags: ["-Wall", "-Werror", "-O3"],
     shared_libs: ["libaaudio"],
     header_libs: ["libaaudio_example_utils"],
 }
@@ -9,7 +9,7 @@ cc_test {
 cc_test {
     name: "write_sine_callback",
     srcs: ["src/write_sine_callback.cpp"],
-    cflags: ["-Wall", "-Werror"],
+    cflags: ["-Wall", "-Werror", "-O3"],
     shared_libs: ["libaaudio"],
     header_libs: ["libaaudio_example_utils"],
 }
diff --git a/media/libaaudio/src/Android.bp b/media/libaaudio/src/Android.bp
index 717f31a92d..3167b64312 100644
--- a/media/libaaudio/src/Android.bp
+++ b/media/libaaudio/src/Android.bp
@@ -21,6 +21,7 @@ cc_library {
     ],
 
     cflags: [
+        "-O3",
         "-Wno-unused-parameter",
         "-Wall",
         "-Werror",
@@ -91,6 +92,7 @@ cc_library {
         "-Wno-unused-parameter",
         "-Wall",
         "-Werror",
+        "-O3",
     ],
 
     srcs: [
diff --git a/media/libaudioclient/Android.bp b/media/libaudioclient/Android.bp
index fa2a159d05..eec4c8fd7f 100644
--- a/media/libaudioclient/Android.bp
+++ b/media/libaudioclient/Android.bp
@@ -32,6 +32,7 @@ cc_library_shared {
         "libutils",
     ],
     cflags: [
+        "-O3",
         "-Werror",
         "-Wall",
     ],
@@ -117,6 +118,7 @@ cc_library_shared {
         "libc_malloc_debug_backtrace",
     ],
     cflags: [
+        "-O3",
         "-Wall",
         "-Werror",
         "-Wno-error=deprecated-declarations",
diff --git a/media/libaudiofoundation/Android.bp b/media/libaudiofoundation/Android.bp
index 548b080f30..b555c2cde5 100644
--- a/media/libaudiofoundation/Android.bp
+++ b/media/libaudiofoundation/Android.bp
@@ -46,6 +46,7 @@ cc_library {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wall",
     ],
diff --git a/media/libaudiohal/Android.bp b/media/libaudiohal/Android.bp
index 1709d1ec4c..8e441de1ac 100644
--- a/media/libaudiohal/Android.bp
+++ b/media/libaudiohal/Android.bp
@@ -8,6 +8,7 @@ cc_library_shared {
     ],
 
     cflags: [
+        "-O3",
         "-Wall",
         "-Wextra",
         "-Werror",
@@ -41,6 +42,7 @@ cc_library_shared {
     ],
 
     cflags: [
+        "-O3",
         "-Wall",
         "-Werror",
     ],
diff --git a/media/libaudiohal/impl/Android.bp b/media/libaudiohal/impl/Android.bp
index 967fba1cff..b776f8bf2c 100644
--- a/media/libaudiohal/impl/Android.bp
+++ b/media/libaudiohal/impl/Android.bp
@@ -17,6 +17,7 @@ cc_defaults {
     ],
 
     cflags: [
+        "-O3",
         "-Wall",
         "-Wextra",
         "-Werror",
@@ -62,6 +63,7 @@ cc_library_shared {
         "android.hardware.audio@2.0",
     ],
     cflags: [
+        "-O3",
         "-DMAJOR_VERSION=2",
         "-DMINOR_VERSION=0",
         "-include common/all-versions/VersionMacro.h",
@@ -78,6 +80,7 @@ cc_library_shared {
         "android.hardware.audio@4.0",
     ],
     cflags: [
+        "-O3",
         "-DMAJOR_VERSION=4",
         "-DMINOR_VERSION=0",
         "-include common/all-versions/VersionMacro.h",
@@ -94,6 +97,7 @@ cc_library_shared {
         "android.hardware.audio@5.0",
     ],
     cflags: [
+        "-O3",
         "-DMAJOR_VERSION=5",
         "-DMINOR_VERSION=0",
         "-include common/all-versions/VersionMacro.h",
@@ -110,6 +114,7 @@ cc_library_shared {
         "android.hardware.audio@6.0",
     ],
     cflags: [
+        "-O3",
         "-DMAJOR_VERSION=6",
         "-DMINOR_VERSION=0",
         "-include common/all-versions/VersionMacro.h",
diff --git a/media/libaudioprocessing/Android.bp b/media/libaudioprocessing/Android.bp
index 39b0ceb1b6..6104896c44 100644
--- a/media/libaudioprocessing/Android.bp
+++ b/media/libaudioprocessing/Android.bp
@@ -13,6 +13,7 @@ cc_defaults {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wall",
 
diff --git a/media/libaudioprocessing/audio-resampler/Android.bp b/media/libaudioprocessing/audio-resampler/Android.bp
index dc703106cf..16d95ec30c 100644
--- a/media/libaudioprocessing/audio-resampler/Android.bp
+++ b/media/libaudioprocessing/audio-resampler/Android.bp
@@ -9,6 +9,7 @@ cc_library_shared {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wall",
     ],
diff --git a/media/libcpustats/Android.bp b/media/libcpustats/Android.bp
index 6e8ca1dda3..6837c47eb2 100644
--- a/media/libcpustats/Android.bp
+++ b/media/libcpustats/Android.bp
@@ -17,6 +17,7 @@ cc_library_static {
     cflags: [
         "-Werror",
         "-Wall",
+        "-O3",
     ],
 
     host_supported: true,
diff --git a/media/libeffects/downmix/Android.bp b/media/libeffects/downmix/Android.bp
index 2a2f36e5ba..c6c6a1e392 100644
--- a/media/libeffects/downmix/Android.bp
+++ b/media/libeffects/downmix/Android.bp
@@ -18,6 +18,7 @@ cc_library_shared {
         "-fvisibility=hidden",
         "-Wall",
         "-Werror",
+        "-O3",
     ],
 
     header_libs: [
diff --git a/media/libeffects/dynamicsproc/Android.bp b/media/libeffects/dynamicsproc/Android.bp
index eafc483272..dbc90d73ab 100644
--- a/media/libeffects/dynamicsproc/Android.bp
+++ b/media/libeffects/dynamicsproc/Android.bp
@@ -25,9 +25,8 @@ cc_library_shared {
     ],
 
     cflags: [
-        "-O2",
+        "-O3",
         "-fvisibility=hidden",
-
         "-Wall",
         "-Werror",
     ],
diff --git a/media/libeffects/factory/Android.bp b/media/libeffects/factory/Android.bp
index ddbfdd8c54..b7a9837d5d 100644
--- a/media/libeffects/factory/Android.bp
+++ b/media/libeffects/factory/Android.bp
@@ -23,7 +23,7 @@ cc_library_shared {
         "libdl",
         "libeffectsconfig",
     ],
-    cflags: ["-fvisibility=hidden"],
+    cflags: ["-fvisibility=hidden", "-O3"],
 
     local_include_dirs:["include/media"],
 
@@ -45,6 +45,7 @@ cc_binary {
         "-Wall",
         "-Wextra",
         "-Werror",
+        "-O3",
     ],
 
 
diff --git a/media/libeffects/loudness/Android.bp b/media/libeffects/loudness/Android.bp
index 5a13af6d0f..4f07e5e986 100644
--- a/media/libeffects/loudness/Android.bp
+++ b/media/libeffects/loudness/Android.bp
@@ -9,9 +9,8 @@ cc_library_shared {
     ],
 
     cflags: [
-        "-O2",
+        "-O3",
         "-fvisibility=hidden",
-
         "-Wall",
         "-Werror",
     ],
diff --git a/media/libeffects/preprocessing/Android.bp b/media/libeffects/preprocessing/Android.bp
index c87635f5b5..e5c713c6a2 100644
--- a/media/libeffects/preprocessing/Android.bp
+++ b/media/libeffects/preprocessing/Android.bp
@@ -26,6 +26,7 @@ cc_library_shared {
         "-fvisibility=hidden",
         "-Wall",
         "-Werror",
+        "-O3",
     ],
 
     header_libs: [
diff --git a/media/libeffects/proxy/Android.bp b/media/libeffects/proxy/Android.bp
index c6abb9ed6e..fe1e94db70 100644
--- a/media/libeffects/proxy/Android.bp
+++ b/media/libeffects/proxy/Android.bp
@@ -23,6 +23,7 @@ cc_library_shared {
         "-fvisibility=hidden",
         "-Wall",
         "-Werror",
+        "-O3",
     ],
 
     include_dirs: ["frameworks/av/media/libeffects/factory"],
diff --git a/media/libheif/Android.bp b/media/libheif/Android.bp
index 7d5a4ebe32..910b38cb9c 100644
--- a/media/libheif/Android.bp
+++ b/media/libheif/Android.bp
@@ -13,6 +13,7 @@ cc_library_shared {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wall",
     ],
diff --git a/media/libmedia/Android.bp b/media/libmedia/Android.bp
index f339d98020..b5a19de78f 100644
--- a/media/libmedia/Android.bp
+++ b/media/libmedia/Android.bp
@@ -118,6 +118,7 @@ cc_library_shared {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wno-error=deprecated-declarations",
         "-Wall",
@@ -177,6 +178,7 @@ cc_library_shared {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wno-error=deprecated-declarations",
         "-Wall",
@@ -208,6 +210,7 @@ cc_library_static {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wno-error=deprecated-declarations",
         "-Wall",
@@ -251,6 +254,7 @@ cc_library_shared {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wno-error=deprecated-declarations",
         "-Wall",
@@ -359,6 +363,7 @@ cc_library {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wno-error=deprecated-declarations",
         "-Wall",
diff --git a/media/libmedia/xsd/vts/Android.bp b/media/libmedia/xsd/vts/Android.bp
index 598e41b547..ed8a9057ca 100644
--- a/media/libmedia/xsd/vts/Android.bp
+++ b/media/libmedia/xsd/vts/Android.bp
@@ -28,6 +28,7 @@ cc_test {
         "liblog",
     ],
     cflags: [
+        "-O3",
         "-Wall",
         "-Werror",
     ],
diff --git a/media/libmediahelper/Android.bp b/media/libmediahelper/Android.bp
index fbe7f8764f..dd3c15c126 100644
--- a/media/libmediahelper/Android.bp
+++ b/media/libmediahelper/Android.bp
@@ -17,6 +17,7 @@ cc_library {
         "TypeConverter.cpp",
     ],
     cflags: [
+        "-O3",
         "-Werror",
         "-Wextra",
         "-Wall",
diff --git a/media/libmediametrics/Android.bp b/media/libmediametrics/Android.bp
index a63b8b4339..92d636fecc 100644
--- a/media/libmediametrics/Android.bp
+++ b/media/libmediametrics/Android.bp
@@ -22,6 +22,7 @@ cc_library_shared {
     export_include_dirs: ["include"],
 
     cflags: [
+        "-O3",
         "-Wall",
         "-Werror",
         "-Wextra",
diff --git a/media/libmediaplayerservice/Android.bp b/media/libmediaplayerservice/Android.bp
index 21da3ce113..b1a3813f20 100644
--- a/media/libmediaplayerservice/Android.bp
+++ b/media/libmediaplayerservice/Android.bp
@@ -68,6 +68,7 @@ cc_library_shared {
     local_include_dirs: ["include"],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wno-error=deprecated-declarations",
         "-Wall",
diff --git a/media/libmediaplayerservice/nuplayer/Android.bp b/media/libmediaplayerservice/nuplayer/Android.bp
index 32c97cff71..aa0cb892c2 100644
--- a/media/libmediaplayerservice/nuplayer/Android.bp
+++ b/media/libmediaplayerservice/nuplayer/Android.bp
@@ -33,6 +33,7 @@ cc_library_static {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wall",
     ],
@@ -41,6 +42,7 @@ cc_library_static {
         debuggable: {
             cflags: [
                 "-DENABLE_STAGEFRIGHT_EXPERIMENTS",
+                "-O3",
             ],
         }
     },
diff --git a/media/libmediatranscoding/Android.bp b/media/libmediatranscoding/Android.bp
index f948bd8d1b..9f93508ee5 100644
--- a/media/libmediatranscoding/Android.bp
+++ b/media/libmediatranscoding/Android.bp
@@ -56,6 +56,7 @@ cc_library_shared {
         "-Werror",
         "-Wno-error=deprecated-declarations",
         "-Wall",
+        "-O3",
     ],
 
     sanitize: {
diff --git a/media/libnbaio/Android.bp b/media/libnbaio/Android.bp
index 04ddcfffeb..2e9488e7d5 100644
--- a/media/libnbaio/Android.bp
+++ b/media/libnbaio/Android.bp
@@ -28,6 +28,7 @@ cc_defaults {
     cflags: [
         "-Werror",
         "-Wall",
+        "-O3",
     ],
 }
 
diff --git a/media/libstagefright/Android.bp b/media/libstagefright/Android.bp
index d4bc8adb1d..2f1aecf00c 100644
--- a/media/libstagefright/Android.bp
+++ b/media/libstagefright/Android.bp
@@ -23,6 +23,7 @@ cc_library_static {
     cflags: [
         "-Werror",
         "-Wall",
+        "-O3",
     ],
     sanitize: {
         misc_undefined: [
@@ -49,6 +50,7 @@ cc_library_static {
     cflags: [
         "-Werror",
         "-Wall",
+        "-O3",
     ],
     sanitize: {
         misc_undefined: [
@@ -79,6 +81,7 @@ cc_library_shared {
     cflags: [
         "-Werror",
         "-Wall",
+        "-O3",
     ],
 
     header_libs: [
@@ -141,6 +144,7 @@ cc_library_static {
         "-Werror",
         "-Wno-error=deprecated-declarations",
         "-Wall",
+        "-O3",
     ],
 
     sanitize: {
@@ -188,6 +192,7 @@ cc_library_shared {
         "-Werror",
         "-Wno-error=deprecated-declarations",
         "-Wall",
+        "-O3",
     ],
 
     sanitize: {
@@ -325,6 +330,7 @@ cc_library {
         "-Werror",
         "-Wno-error=deprecated-declarations",
         "-Wall",
+        "-O3",
     ],
 
     version_script: "exports.lds",
@@ -332,7 +338,7 @@ cc_library {
     product_variables: {
         debuggable: {
             // enable experiments only in userdebug and eng builds
-            cflags: ["-DENABLE_STAGEFRIGHT_EXPERIMENTS"],
+            cflags: ["-DENABLE_STAGEFRIGHT_EXPERIMENTS", "-O3"],
         },
     },
 
diff --git a/media/libstagefright/codecs/amrnb/common/Android.bp b/media/libstagefright/codecs/amrnb/common/Android.bp
index 59a791dfb0..2a1d452854 100644
--- a/media/libstagefright/codecs/amrnb/common/Android.bp
+++ b/media/libstagefright/codecs/amrnb/common/Android.bp
@@ -71,8 +71,8 @@ cc_library {
         "-DOSCL_UNUSED_ARG(x)=(void)(x)",
         "-DOSCL_IMPORT_REF=",
         "-DOSCL_EXPORT_REF=",
-
         "-Werror",
+        "-O3",
     ],
 
     target: {
diff --git a/media/libstagefright/codecs/amrnb/dec/Android.bp b/media/libstagefright/codecs/amrnb/dec/Android.bp
index b8e00b32be..09acecb557 100644
--- a/media/libstagefright/codecs/amrnb/dec/Android.bp
+++ b/media/libstagefright/codecs/amrnb/dec/Android.bp
@@ -47,8 +47,8 @@ cc_library_static {
     cflags: [
         "-DOSCL_UNUSED_ARG(x)=(void)(x)",
         "-DOSCL_IMPORT_REF=",
-
         "-Werror",
+        "-O3",
     ],
 
     version_script: "exports.lds",
@@ -83,6 +83,7 @@ cc_library_shared {
 
     cflags: [
         "-DOSCL_IMPORT_REF=",
+        "-O3",
     ],
 
     version_script: "exports.lds",
@@ -112,7 +113,7 @@ cc_test {
 
     srcs: ["test/amrnbdec_test.cpp"],
 
-    cflags: ["-Wall", "-Werror"],
+    cflags: ["-Wall", "-Werror", "-O3"],
 
     local_include_dirs: ["src"],
 
diff --git a/media/libstagefright/codecs/amrwb/Android.bp b/media/libstagefright/codecs/amrwb/Android.bp
index 204cbe3e83..3bc71605cb 100644
--- a/media/libstagefright/codecs/amrwb/Android.bp
+++ b/media/libstagefright/codecs/amrwb/Android.bp
@@ -54,8 +54,8 @@ cc_library_static {
     cflags: [
         "-DOSCL_UNUSED_ARG(x)=(void)(x)",
         "-DOSCL_IMPORT_REF=",
-
         "-Werror",
+        "-O3",
     ],
 
     sanitize: {
@@ -79,7 +79,7 @@ cc_test {
 
     srcs: ["test/amrwbdec_test.cpp"],
 
-    cflags: ["-Wall", "-Werror"],
+    cflags: ["-Wall", "-Werror", "-O3"],
 
     static_libs: [
         "libstagefright_amrwbdec",
diff --git a/media/libstagefright/codecs/amrwbenc/Android.bp b/media/libstagefright/codecs/amrwbenc/Android.bp
index 64f302c8ec..2bed93ba95 100644
--- a/media/libstagefright/codecs/amrwbenc/Android.bp
+++ b/media/libstagefright/codecs/amrwbenc/Android.bp
@@ -70,6 +70,7 @@ cc_library_static {
             ],
 
             cflags: [
+                "-O3",
                 "-DARM",
                 "-DASM_OPT",
             ],
@@ -108,6 +109,7 @@ cc_library_static {
 
                 // don't actually generate neon instructions, see bug 26932980
                 cflags: [
+                    "-O3",
                     "-DARMV7",
                     "-mfpu=vfpv3",
                 ],
@@ -133,7 +135,7 @@ cc_library_static {
         "liblog",
     ],
 
-    cflags: ["-Werror"],
+    cflags: ["-Werror", "-O3"],
     sanitize: {
         cfi: true,
     },
diff --git a/media/libstagefright/codecs/avcdec/Android.bp b/media/libstagefright/codecs/avcdec/Android.bp
index 0bb6bb067e..1259512fb3 100644
--- a/media/libstagefright/codecs/avcdec/Android.bp
+++ b/media/libstagefright/codecs/avcdec/Android.bp
@@ -6,6 +6,7 @@ cc_library_shared {
     srcs: ["SoftAVCDec.cpp"],
 
     cflags: [
+        "-O3",
         "-Wall",
     ],
 
diff --git a/media/libstagefright/codecs/avcenc/Android.bp b/media/libstagefright/codecs/avcenc/Android.bp
index 980261c2a1..b8816f89c3 100644
--- a/media/libstagefright/codecs/avcenc/Android.bp
+++ b/media/libstagefright/codecs/avcenc/Android.bp
@@ -13,6 +13,7 @@ cc_library_shared {
     },
 
     cflags: [
+        "-O3",
         "-Wall",
         "-Wno-unused-variable",
     ],
diff --git a/media/libstagefright/codecs/common/Android.bp b/media/libstagefright/codecs/common/Android.bp
index 260a60a161..d8bf914697 100644
--- a/media/libstagefright/codecs/common/Android.bp
+++ b/media/libstagefright/codecs/common/Android.bp
@@ -13,5 +13,5 @@ cc_library {
 
     export_include_dirs: ["include"],
 
-    cflags: ["-Werror"],
+    cflags: ["-Werror", "-O3"],
 }
diff --git a/media/libstagefright/codecs/hevcdec/Android.bp b/media/libstagefright/codecs/hevcdec/Android.bp
index ec436ce7d9..342b24f30f 100644
--- a/media/libstagefright/codecs/hevcdec/Android.bp
+++ b/media/libstagefright/codecs/hevcdec/Android.bp
@@ -6,6 +6,7 @@ cc_library_shared {
     srcs: ["SoftHEVC.cpp"],
 
     cflags: [
+        "-O3",
         "-Wall",
         "-Wno-unused-variable",
     ],
diff --git a/media/libstagefright/codecs/m4v_h263/dec/Android.bp b/media/libstagefright/codecs/m4v_h263/dec/Android.bp
index 4303565fb3..6c14436e19 100644
--- a/media/libstagefright/codecs/m4v_h263/dec/Android.bp
+++ b/media/libstagefright/codecs/m4v_h263/dec/Android.bp
@@ -53,6 +53,7 @@ cc_library_static {
 
     cflags: [
         "-Werror",
+        "-O3",
     ],
 
     version_script: "exports.lds",
@@ -76,6 +77,7 @@ cc_library_shared {
     local_include_dirs: ["src"],
 
     cflags: [
+        "-O3",
     ],
 
     static_libs: ["libstagefright_m4vh263dec"],
diff --git a/media/libstagefright/codecs/mp3dec/Android.bp b/media/libstagefright/codecs/mp3dec/Android.bp
index 96106f1bc9..016877a9f3 100644
--- a/media/libstagefright/codecs/mp3dec/Android.bp
+++ b/media/libstagefright/codecs/mp3dec/Android.bp
@@ -72,6 +72,7 @@ cc_library_static {
     cflags: [
         "-DOSCL_UNUSED_ARG(x)=(void)(x)",
         "-Werror",
+        "-O3",
     ],
 }
 
@@ -110,7 +111,7 @@ cc_test {
         "test/mp3reader.cpp",
     ],
 
-    cflags: ["-Wall", "-Werror"],
+    cflags: ["-Wall", "-Werror", "-O3"],
 
     local_include_dirs: [
         "src",
diff --git a/media/libstagefright/codecs/mpeg2dec/Android.bp b/media/libstagefright/codecs/mpeg2dec/Android.bp
index e849410b99..36e04c9ac8 100644
--- a/media/libstagefright/codecs/mpeg2dec/Android.bp
+++ b/media/libstagefright/codecs/mpeg2dec/Android.bp
@@ -6,6 +6,7 @@ cc_library_shared {
     srcs: ["SoftMPEG2.cpp"],
 
     cflags: [
+        "-O3",
         "-Wall",
         "-Wno-unused-variable",
     ],
diff --git a/media/libstagefright/codecs/on2/enc/Android.bp b/media/libstagefright/codecs/on2/enc/Android.bp
index 705e554de8..6dd24fd5f6 100644
--- a/media/libstagefright/codecs/on2/enc/Android.bp
+++ b/media/libstagefright/codecs/on2/enc/Android.bp
@@ -8,7 +8,7 @@ cc_library_shared {
         "SoftVP9Encoder.cpp",
     ],
 
-    cflags: ["-Wall"],
+    cflags: ["-Wall", "-O3"],
 
     version_script: "exports.lds",
 
diff --git a/media/libstagefright/codecs/xaacdec/Android.bp b/media/libstagefright/codecs/xaacdec/Android.bp
index 5385dbcbab..f76ea902fe 100644
--- a/media/libstagefright/codecs/xaacdec/Android.bp
+++ b/media/libstagefright/codecs/xaacdec/Android.bp
@@ -7,7 +7,8 @@ cc_library_shared {
     ],
 
     cflags: [
-        "-DENABLE_MPEG_D_DRC"
+        "-DENABLE_MPEG_D_DRC",
+        "-O3"
     ],
 
     sanitize: {
diff --git a/media/libstagefright/colorconversion/Android.bp b/media/libstagefright/colorconversion/Android.bp
index 6b08b08578..738617d2c2 100644
--- a/media/libstagefright/colorconversion/Android.bp
+++ b/media/libstagefright/colorconversion/Android.bp
@@ -22,7 +22,7 @@ cc_library_static {
 
     static_libs: ["libyuv_static"],
 
-    cflags: ["-Werror"],
+    cflags: ["-Werror", "-O3"],
 
     sanitize: {
         misc_undefined: [
diff --git a/media/libstagefright/filters/Android.bp b/media/libstagefright/filters/Android.bp
index 88f30c47b3..94b52efbb7 100644
--- a/media/libstagefright/filters/Android.bp
+++ b/media/libstagefright/filters/Android.bp
@@ -21,6 +21,7 @@ cc_library_static {
         "-Wno-multichar",
         "-Werror",
         "-Wall",
+        "-O3",
     ],
 
     header_libs: [
diff --git a/media/libstagefright/flac/dec/Android.bp b/media/libstagefright/flac/dec/Android.bp
index 32b207592a..576fe370e5 100644
--- a/media/libstagefright/flac/dec/Android.bp
+++ b/media/libstagefright/flac/dec/Android.bp
@@ -9,7 +9,7 @@ cc_library {
 
     export_include_dirs: [ "." ],
 
-    cflags: ["-Werror"],
+    cflags: ["-Werror", "-O3"],
 
     sanitize: {
         misc_undefined: [
diff --git a/media/libstagefright/foundation/Android.bp b/media/libstagefright/foundation/Android.bp
index f440e00a5c..45b03dc13c 100644
--- a/media/libstagefright/foundation/Android.bp
+++ b/media/libstagefright/foundation/Android.bp
@@ -40,6 +40,7 @@ cc_defaults {
         "-Wno-multichar",
         "-Werror",
         "-Wall",
+        "-O3",
     ],
 
     shared_libs: [
@@ -84,6 +85,7 @@ cc_defaults {
             ],
             cflags: [
                 "-DNO_IMEMORY",
+                "-O3",
             ],
         },
     },
@@ -115,5 +117,6 @@ cc_library_static {
         "-Werror",
         "-Wall",
         "-DNO_IMEMORY",
+        "-O3",
     ],
 }
diff --git a/media/libstagefright/http/Android.bp b/media/libstagefright/http/Android.bp
index 8655caf9a1..3b59f0b91a 100644
--- a/media/libstagefright/http/Android.bp
+++ b/media/libstagefright/http/Android.bp
@@ -22,6 +22,7 @@ cc_library_shared {
         "-Wno-multichar",
         "-Werror",
         "-Wall",
+        "-O3",
     ],
 
     sanitize: {
diff --git a/media/libstagefright/mpeg2ts/Android.bp b/media/libstagefright/mpeg2ts/Android.bp
index fbb2d0c9ed..d1ec473d7a 100644
--- a/media/libstagefright/mpeg2ts/Android.bp
+++ b/media/libstagefright/mpeg2ts/Android.bp
@@ -15,6 +15,7 @@ cc_library_static {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wall",
     ],
diff --git a/media/libstagefright/omx/Android.bp b/media/libstagefright/omx/Android.bp
index a049fc57ec..2f6a5fef3c 100644
--- a/media/libstagefright/omx/Android.bp
+++ b/media/libstagefright/omx/Android.bp
@@ -59,6 +59,7 @@ cc_library_shared {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wall",
         "-Wno-unused-parameter",
@@ -106,6 +107,7 @@ cc_library_shared {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wall",
         "-Wno-unused-parameter",
@@ -149,6 +151,7 @@ cc_library_shared {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wall",
         "-Wno-unused-parameter",
@@ -169,6 +172,7 @@ cc_defaults {
     vendor_available: true,
 
     cflags: [
+        "-O3",
         "-Werror",
     ],
 
@@ -226,6 +230,6 @@ cc_library_shared {
         ],
         cfi: true,
     },
-    cflags: ["-Wall", "-Werror"],
+    cflags: ["-Wall", "-Werror", "-O3"],
 }
 
diff --git a/media/libstagefright/rtsp/Android.bp b/media/libstagefright/rtsp/Android.bp
index a5a895e472..a80a913b4d 100644
--- a/media/libstagefright/rtsp/Android.bp
+++ b/media/libstagefright/rtsp/Android.bp
@@ -32,13 +32,14 @@ cc_defaults {
 
     arch: {
         arm: {
-            cflags: ["-Wno-psabi"],
+            cflags: ["-Wno-psabi", "-O3"],
         },
     },
 
     cflags: [
         "-Werror",
         "-Wall",
+        "-O3",
     ],
 
     sanitize: {
@@ -95,6 +96,7 @@ cc_test {
         "-Wno-multichar",
         "-Werror",
         "-Wall",
+        "-O3",
     ],
 
     sanitize: {
diff --git a/media/libstagefright/webm/Android.bp b/media/libstagefright/webm/Android.bp
index 2cebe8fcda..34c2248be4 100644
--- a/media/libstagefright/webm/Android.bp
+++ b/media/libstagefright/webm/Android.bp
@@ -1,11 +1,12 @@
 cc_library_static {
     name: "libstagefright_webm",
 
-    cppflags: ["-D__STDINT_LIMITS"],
+    cppflags: ["-D__STDINT_LIMITS", "-O3"],
 
     cflags: [
         "-Werror",
         "-Wall",
+        "-O3",
     ],
 
     sanitize: {
diff --git a/media/mediaserver/Android.bp b/media/mediaserver/Android.bp
index 1759ff66f6..f51c049fe0 100644
--- a/media/mediaserver/Android.bp
+++ b/media/mediaserver/Android.bp
@@ -6,6 +6,7 @@ cc_library_static {
     cflags: [
         "-Werror",
         "-Wall",
+        "-O3",
     ],
 }
 
@@ -45,6 +46,7 @@ cc_binary {
     cflags: [
         "-Werror",
         "-Wall",
+        "-O3",
     ],
 
     vintf_fragments: ["manifest_media_c2_software.xml"],
diff --git a/media/mtp/Android.bp b/media/mtp/Android.bp
index 66a31392fd..d47c9cf1d7 100644
--- a/media/mtp/Android.bp
+++ b/media/mtp/Android.bp
@@ -45,6 +45,7 @@ cc_library_shared {
         "-Wall",
         "-Wextra",
         "-Werror",
+        "-O3",
     ],
     shared_libs: [
         "libasyncio",
diff --git a/media/ndk/Android.bp b/media/ndk/Android.bp
index 43989bb13b..59181337aa 100644
--- a/media/ndk/Android.bp
+++ b/media/ndk/Android.bp
@@ -72,6 +72,7 @@ cc_library_shared {
         "-DEXPORT=__attribute__((visibility(\"default\")))",
         "-Werror",
         "-Wall",
+        "-O3",
     ],
 
     static_libs: [
@@ -149,6 +150,7 @@ cc_library {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wno-error=deprecated-declarations",
         "-Wall",
@@ -190,6 +192,7 @@ cc_test {
 
     cflags: [
         "-D__ANDROID_VNDK__",
+        "-O3",
     ],
     include_dirs: [
         "frameworks/av/media/ndk/",
diff --git a/media/utils/Android.bp b/media/utils/Android.bp
index e3f1e44eaf..a093d8caab 100644
--- a/media/utils/Android.bp
+++ b/media/utils/Android.bp
@@ -43,6 +43,7 @@ cc_library {
     logtags: ["EventLogTags.logtags"],
 
     cflags: [
+        "-O3",
         "-Wall",
         "-Wextra",
         "-Werror",
diff --git a/services/audioflinger/Android.bp b/services/audioflinger/Android.bp
index 38736005ee..8980996b42 100644
--- a/services/audioflinger/Android.bp
+++ b/services/audioflinger/Android.bp
@@ -72,6 +72,7 @@ cc_library_shared {
         "-fvisibility=hidden",
         "-Werror",
         "-Wall",
+        "-O3",
     ],
     sanitize: {
         integer_overflow: true,
diff --git a/services/camera/libcameraservice/Android.bp b/services/camera/libcameraservice/Android.bp
index aa15e14d1e..6af3326cb5 100644
--- a/services/camera/libcameraservice/Android.bp
+++ b/services/camera/libcameraservice/Android.bp
@@ -159,6 +159,7 @@ cc_library_shared {
     export_include_dirs: ["."],
 
     cflags: [
+        "-O3",
         "-Wall",
         "-Wextra",
         "-Werror",
diff --git a/services/mediacodec/Android.bp b/services/mediacodec/Android.bp
index c4efbaa141..cd2b276cdb 100644
--- a/services/mediacodec/Android.bp
+++ b/services/mediacodec/Android.bp
@@ -34,6 +34,7 @@ cc_binary {
     init_rc: ["mediaswcodec.rc"],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wall",
         "-Wno-error=deprecated-declarations",
@@ -123,6 +124,7 @@ cc_binary {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wall",
         "-Wno-error=deprecated-declarations",
diff --git a/services/mediaextractor/Android.bp b/services/mediaextractor/Android.bp
index 0b25d62790..8fe71f3e01 100644
--- a/services/mediaextractor/Android.bp
+++ b/services/mediaextractor/Android.bp
@@ -4,6 +4,7 @@ cc_library_shared {
     cflags: [
         "-Wall",
         "-Werror",
+        "-O3",
     ],
     srcs: ["MediaExtractorService.cpp"],
 
@@ -54,6 +55,7 @@ cc_binary {
     cflags: [
         "-Wall",
         "-Werror",
+        "-O3",
     ],
 
     required: ["mediaextractor.policy"],
diff --git a/services/mediametrics/Android.bp b/services/mediametrics/Android.bp
index 91590e1136..ab66831e62 100644
--- a/services/mediametrics/Android.bp
+++ b/services/mediametrics/Android.bp
@@ -55,6 +55,7 @@ cc_defaults {
     // https://clang.llvm.org/docs/UsersManual.html#command-line-options
     // https://clang.llvm.org/docs/DiagnosticsReference.html
     cflags: [
+        "-O3",
         "-Wall",
         "-Wdeprecated",
         "-Werror",
diff --git a/services/mediatranscoding/Android.bp b/services/mediatranscoding/Android.bp
index 17347a98ef..aaadce20c6 100644
--- a/services/mediatranscoding/Android.bp
+++ b/services/mediatranscoding/Android.bp
@@ -17,6 +17,7 @@ cc_library_shared {
     ],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wall",
     ],
@@ -59,6 +60,7 @@ cc_binary {
     init_rc: ["mediatranscoding.rc"],
 
     cflags: [
+        "-O3",
         "-Werror",
         "-Wall",
     ],
diff --git a/services/minijail/Android.bp b/services/minijail/Android.bp
index b057968711..b482258488 100644
--- a/services/minijail/Android.bp
+++ b/services/minijail/Android.bp
@@ -1,6 +1,7 @@
 minijail_common_cflags = [
     "-Wall",
     "-Werror",
+    "-O3",
 ]
 
 cc_defaults {
-- 
2.25.1

